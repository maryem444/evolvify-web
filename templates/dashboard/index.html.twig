{% extends 'base.html.twig' %}

{% block title %}Dashboard - Evolvify{% endblock %}

{% block stylesheets %}
    {{ parent() }}
    <style>
        /* Styles intégrés pour éviter de créer un fichier CSS supplémentaire */
        .card {
            border: none;
            box-shadow: 0 1px 20px 0 rgba(69, 90, 100, 0.08);
            transition: all 0.3s ease;
            margin-bottom: 1.5rem;
        }
        .card:hover {
            box-shadow: 0 5px 25px 0 rgba(69, 90, 100, 0.15);
        }
        
        .card-round {
            border-radius: 12px;
        }
        
        .icon-big {
            width: 48px;
            height: 48px;
            line-height: 48px;
            font-size: 22px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .icon-primary {
            background: rgba(21, 114, 232, 0.1);
            color: #1572E8;
        }
        
        .icon-info {
            background: rgba(72, 171, 247, 0.1);
            color: #48ABF7;
        }
        
        .icon-success {
            background: rgba(49, 206, 54, 0.1);
            color: #31CE36;
        }
        
        .icon-secondary {
            background: rgba(104, 97, 206, 0.1);
            color: #6861CE;
        }
        
        .card-category {
            font-size: 0.875rem;
            color: #8d9498;
        }
        
        .card-title {
            font-weight: 600;
            margin-bottom: 0;
        }
        
        .avatar {
            width: 40px;
            height: 40px;
            overflow: hidden;
            border-radius: 50%;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .avatar-title {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100%;
            font-weight: 600;
            color: #fff;
        }
        
        .card-list .item-list {
            display: flex;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #eee;
        }
        
        .card-list .item-list:last-child {
            border-bottom: none;
        }
        
        .info-user .username {
            font-weight: 600;
        }
        
        .info-user .status {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .btn-refresh-card {
            transition: transform 0.2s ease;
        }
        
        .btn-refresh-card:hover {
            transform: rotate(15deg);
        }
        
        .chart-container {
            position: relative;
        }
        
        .table-responsive {
            overflow-x: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="page-inner">
        <div class="d-flex align-items-left align-items-md-center flex-column flex-md-row pt-2 pb-4">
            <div>
                <h3 class="fw-bold mb-2">Dashboard</h3>
                <h6 class="op-7 mb-2">Bienvenue, {{ user.firstname ?? user.username }}</h6>
            </div>
            <div class="ms-md-auto py-2 py-md-0">
                <a href="#" class="btn btn-primary btn-round">
                    <i class="fas fa-plus me-2"></i>Nouvel Employé
                </a>
            </div>
        </div>
        
        <!-- Cartes statistiques -->
        <div class="row">
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-primary">
                                    <i class="fas fa-users"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3">
                                <div class="numbers">
                                    <p class="card-category">Employés</p>
                                    <h4 class="card-title">{{ employeCount|default(0) }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-info">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3">
                                <div class="numbers">
                                    <p class="card-category">Absences</p>
                                    <h4 class="card-title">{{ absenceCount|default(0) }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-success">
                                    <i class="fas fa-project-diagram"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3">
                                <div class="numbers">
                                    <p class="card-category">Projets</p>
                                    <h4 class="card-title">{{ projectCount|default(0) }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-sm-6 col-md-3">
                <div class="card card-stats card-round">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-icon">
                                <div class="icon-big text-center icon-secondary">
                                    <i class="fas fa-tasks"></i>
                                </div>
                            </div>
                            <div class="col col-stats ms-3">
                                <div class="numbers">
                                    <p class="card-category">Tâches</p>
                                    <h4 class="card-title">{{ taskCount|default(0) }}</h4>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Graphiques -->
        <div class="row">
            <div class="col-md-8">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Activité du Personnel</h4>
                            <button class="btn btn-icon btn-link btn-primary btn-refresh-card">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="min-height: 375px">
                            <canvas id="activityChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card card-primary card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <h4 class="card-title mb-0">Statut des Projets</h4>
                                <p class="text-muted small mb-0">Distribution actuelle</p>
                            </div>
                            <button class="btn btn-icon btn-link btn-primary btn-refresh-card">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="chart-container" style="height: 300px">
                            <canvas id="projectStatusChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Liste des employés récents -->
        <div class="row">
            <div class="col-md-6">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Employés Récents</h4>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="card-list">
                            {% if recentEmployees is defined and recentEmployees|length > 0 %}
                                {% for employee in recentEmployees %}
                                <div class="item-list">
                                    <div class="avatar">
                                        {% if employee.profilePhoto is defined and employee.profilePhoto %}
                                            <img src="{{ asset('uploads/profile_photos/' ~ employee.profilePhoto) }}" class="avatar-img" alt="Photo">
                                        {% else %}
                                            <span class="avatar-title rounded-circle bg-primary">
                                                {{ (employee.firstname|default('U'))[0:1] }}{{ (employee.lastname|default('S'))[0:1] }}
                                            </span>
                                        {% endif %}
                                    </div>
                                    <div class="info-user ms-3">
                                        <div class="username">
                                            {{ employee.firstname|default('') }} {{ employee.lastname|default('') }}
                                        </div>
                                        <div class="status">{{ employee.role|default('Employé') }}</div>
                                    </div>
                                    <div class="ms-auto">
                                        <a href="#" class="btn btn-icon btn-link">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                    </div>
                                </div>
                                {% endfor %}
                            {% else %}
                                <div class="text-center py-3">
                                    <p class="text-muted">Aucun employé récent à afficher</p>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Absences à venir -->
            <div class="col-md-6">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Absences à Venir</h4>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Employé</th>
                                        <th>Type</th>
                                        <th>Date</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if upcomingAbsences is defined and upcomingAbsences|length > 0 %}
                                        {% for absence in upcomingAbsences %}
                                        <tr>
                                            <td>
                                                {% if absence.employe is defined %}
                                                    {{ absence.employe.firstname|default('') }} {{ absence.employe.lastname|default('') }}
                                                {% else %}
                                                    Employé
                                                {% endif %}
                                            </td>
                                            <td>{{ absence.type|default('Congé') }}</td>
                                            <td>
                                                {% if absence.date is defined %}
                                                    {{ absence.date|date('d/m/Y') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if absence.status is defined %}
                                                    {% if absence.status == 'ABSENT' %}
                                                        <span class="badge bg-danger">Absent</span>
                                                    {% elseif absence.status == 'PRESENT' %}
                                                        <span class="badge bg-success">Présent</span>
                                                    {% elseif absence.status == 'EN_CONGE' %}
                                                        <span class="badge bg-warning">En congé</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ absence.status }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="4" class="text-center">Aucune absence à venir</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Projets récents -->
        <div class="row">
            <div class="col-md-12">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Projets Récents</h4>
                            <a href="#" class="btn btn-sm btn-primary">Voir tous</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Nom du Projet</th>
                                        <th>Description</th>
                                        <th>Date début</th>
                                        <th>Date fin</th>
                                        <th>Statut</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recentProjects is defined and recentProjects|length > 0 %}
                                        {% for project in recentProjects %}
                                        <tr>
                                            <td>{{ project.name|default('Projet '~loop.index) }}</td>
                                            <td>{{ (project.description|default(''))|length > 30 ? (project.description|slice(0, 30) ~ '...') : project.description|default('') }}</td>
                                            <td>
                                                {% if project.starter_at is defined %}
                                                    {{ project.starter_at|date('d/m/Y') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if project.end_date is defined %}
                                                    {{ project.end_date|date('d/m/Y') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if project.status is defined %}
                                                    {% if project.status == 'COMPLETED' %}
                                                        <span class="badge bg-success">Terminé</span>
                                                    {% elseif project.status == 'IN_PROGRESS' %}
                                                        <span class="badge bg-info">En cours</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ project.status }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                <div class="d-flex">
                                                    <a href="#" class="btn btn-icon btn-link text-primary"><i class="fas fa-eye"></i></a>
                                                    <a href="#" class="btn btn-icon btn-link text-warning"><i class="fas fa-edit"></i></a>
                                                </div>
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">Aucun projet récent à afficher</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tâches récentes -->
        <div class="row">
            <div class="col-md-12">
                <div class="card card-round">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <h4 class="card-title mb-0">Tâches Récentes</h4>
                            <a href="#" class="btn btn-sm btn-primary">Voir toutes</a>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>Description</th>
                                        <th>Projet</th>
                                        <th>Employé</th>
                                        <th>Priorité</th>
                                        <th>Date création</th>
                                        <th>Statut</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% if recentTasks is defined and recentTasks|length > 0 %}
                                        {% for task in recentTasks %}
                                        <tr>
                                            <td>{{ (task.description|default(''))|length > 30 ? (task.description|slice(0, 30) ~ '...') : task.description|default('') }}</td>
                                            <td>
                                                {% if task.projet is defined and task.projet %}
                                                    {{ task.projet.name|default('Projet #' ~ task.id_projet) }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.employe is defined and task.employe %}
                                                    {{ task.employe.firstname|default('') }} {{ task.employe.lastname|default('') }}
                                                {% else %}
                                                    Non assigné
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.priority is defined %}
                                                    {% if task.priority == 'HIGH' %}
                                                        <span class="badge bg-danger">Haute</span>
                                                    {% elseif task.priority == 'MEDIUM' %}
                                                        <span class="badge bg-warning">Moyenne</span>
                                                    {% elseif task.priority == 'LOW' %}
                                                        <span class="badge bg-info">Basse</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ task.priority }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.created_at is defined %}
                                                    {{ task.created_at|date('d/m/Y') }}
                                                {% else %}
                                                    N/A
                                                {% endif %}
                                            </td>
                                            <td>
                                                {% if task.status is defined %}
                                                    {% if task.status == 'DONE' %}
                                                        <span class="badge bg-success">Terminée</span>
                                                    {% elseif task.status == 'IN_PROGRESS' %}
                                                        <span class="badge bg-info">En cours</span>
                                                    {% elseif task.status == 'TO_DO' %}
                                                        <span class="badge bg-warning">À faire</span>
                                                    {% elseif task.status == 'CANCELED' %}
                                                        <span class="badge bg-danger">Annulée</span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">{{ task.status }}</span>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="badge bg-secondary">N/A</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        {% endfor %}
                                    {% else %}
                                        <tr>
                                            <td colspan="6" class="text-center">Aucune tâche récente à afficher</td>
                                        </tr>
                                    {% endif %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block javascripts %}
{{ parent() }}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Configuration des graphiques si Chart.js est disponible
    if (typeof Chart !== 'undefined') {
        // Graphique d'activité
        const activityCtx = document.getElementById('activityChart');
        if (activityCtx) {
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: {{ chartLabels|json_encode|raw }},
                    datasets: [
                        {
                            label: 'Projets',
                            data: {{ projectData|json_encode|raw }},
                            borderColor: '#1572E8',
                            backgroundColor: 'rgba(21, 114, 232, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Tâches',
                            data: {{ taskData|json_encode|raw }},
                            borderColor: '#31CE36',
                            backgroundColor: 'rgba(49, 206, 54, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Absences',
                            data: {{ absenceData|json_encode|raw }},
                            borderColor: '#F25961',
                            backgroundColor: 'rgba(242, 89, 97, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // Graphique de statut des projets
        const projectStatusCtx = document.getElementById('projectStatusChart');
        if (projectStatusCtx) {
            new Chart(projectStatusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['En cours', 'Terminés'],
                    datasets: [{
                        data: [
                            {{ inProgressProjects|default(2) }}, 
                            {{ completedProjects|default(1) }}
                        ],
                        backgroundColor: ['#48ABF7', '#31CE36'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    }
                }
            });
        }
    }

    // Fonctionnalité pour les boutons de rafraîchissement
    document.querySelectorAll('.btn-refresh-card').forEach(button => {
        button.addEventListener('click', function() {
            // Animation de rotation au clic
            this.style.transform = 'rotate(180deg)';
            setTimeout(() => {
                this.style.transform = '';
            }, 500);
            
            // Ici vous pourriez ajouter une requête AJAX pour rafraîchir les données
        });
    });
});
</script>
{% endblock %}