{% extends 'base.html.twig' %}

{% block title %}Tableau de bord RH
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
	<style>
		.card {
			border-radius: 10px;
			box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
			margin-bottom: 20px;
		}

		.card-header {
			font-weight: bold;
			border-bottom: 1px solid rgba(0, 0, 0, 0.1);
			padding: 15px 20px;
			border-radius: 10px 10px 0 0;
			background-color: #f8f9fa;
		}

		.card-body {
			padding: 20px;
		}

		.stats-card {
			text-align: center;
			padding: 20px;
		}

		.stats-card i {
			font-size: 2.5rem;
			margin-bottom: 15px;
		}

		.stats-card .number {
			font-size: 2rem;
			font-weight: bold;
			margin-bottom: 10px;
		}

		.stats-card .label {
			font-size: 1rem;
			color: #6c757d;
		}
	</style>
{% endblock %}

{% block content %}
	<div class="container-fluid my-4">
		<h1 class="mb-4" style="margin-top: 100px;">
			<i class="fas fa-tachometer-alt me-2"></i>
			Tableau de bord
		</h1>

		<!-- Debug text to see if template is rendering -->
		<div class="alert alert-info">
			Welcome to your dashboard,
			{% if app.user %}
				{{ app.user.firstname ?? app.user.lastname ?? 'Unknown' }}!
			{% endif %}
		</div>


		<!-- Top Stats Cards -->
		<div class="row mb-4">
			<div class="col-md-3">
				<div class="card stats-card">
					<i class="fas fa-users text-primary"></i>
					{% if userCount is defined %}
						<div class="number">{{ userCount }}</div>
						<div class="label">Employés totaux</div>
					{% else %}
						<div class="number">-</div>
						<div class="label">Employés totaux</div>
					{% endif %}
				</div>
			</div>
			<div class="col-md-3">
				<div class="card stats-card">
					<i class="fas fa-project-diagram text-success"></i>
					{% if projectsByStatus is defined and projectsByStatus %}
						<div class="number">{{ projectsByStatus|reduce((sum, status) => sum + status.count, 0) }}</div>
						<div class="label">Projets</div>
					{% else %}
						<div class="number">-</div>
						<div class="label">Projets</div>
					{% endif %}
				</div>
			</div>
			<div class="col-md-3">
				<div class="card stats-card">
					<i class="fas fa-tasks text-info"></i>
					{% if tasksByStatus is defined and tasksByStatus %}
						<div class="number">{{ tasksByStatus|reduce((sum, status) => sum + status.count, 0) }}</div>
						<div class="label">Tâches</div>
					{% else %}
						<div class="number">-</div>
						<div class="label">Tâches</div>
					{% endif %}
				</div>
			</div>
			<div class="col-md-3">
				<div class="card stats-card">
					<i class="fas fa-calendar-alt text-warning"></i>
					{% if leavesByStatus is defined and leavesByStatus %}
						<div class="number">{{ leavesByStatus|reduce((sum, status) => sum + status.count, 0) }}</div>
						<div class="label">Congés</div>
					{% else %}
						<div class="number">-</div>
						<div class="label">Congés</div>
					{% endif %}
				</div>
			</div>
		</div>

		<!-- Recent Projects -->
		<div class="card mb-4">
			<div class="card-header">
				<i class="fas fa-project-diagram me-2"></i>
				Projets récents
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th>Nom</th>
								<th>Date début</th>
								<th>Date fin</th>
								<th>Statut</th>
								<th>Membres</th>
							</tr>
						</thead>
						<tbody>
							{% if recentProjects is defined and recentProjects %}
								{% for project in recentProjects %}
									<tr>
										<td>{{ project.name }}</td>
										<td>{{ project.starterAt|date('d/m/Y') }}</td>
										<td>{{ project.endDate|date('d/m/Y') }}</td>
										<td>
											{% set statusClass = '' %}
											{% if project.status == 'EN_COURS' %}
												{% set statusClass = 'bg-info' %}
											{% elseif project.status == 'TERMINE' %}
												{% set statusClass = 'bg-success' %}
											{% elseif project.status == 'EN_ATTENTE' %}
												{% set statusClass = 'bg-warning' %}
											{% elseif project.status == 'ANNULE' %}
												{% set statusClass = 'bg-danger' %}
											{% endif %}
											<span class="badge {{ statusClass }}">{{ project.status }}</span>
										</td>
										<td>{{ project.assignedUsers|length }}</td>
									</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="5" class="text-center">No recent projects found</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Recent Tasks -->
		<div class="card mb-4">
			<div class="card-header">
				<i class="fas fa-tasks me-2"></i>
				Tâches récentes
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-hover">
						<thead>
							<tr>
								<th>Description</th>
								<th>Projet</th>
								<th>Assigné à</th>
								<th>Priorité</th>
								<th>Statut</th>
							</tr>
						</thead>
						<tbody>
							{% if recentTasks is defined and recentTasks %}
								{% for task in recentTasks %}
									<tr>
										<td>{{ task.description }}</td>
										<td>{{ task.projet ? task.projet.name : 'N/A' }}</td>
										<td>{{ task.employeFullName }}</td>
										<td>
											{% set priorityClass = '' %}
											{% if task.priority == 'HAUTE' %}
												{% set priorityClass = 'bg-danger' %}
											{% elseif task.priority == 'MOYENNE' %}
												{% set priorityClass = 'bg-warning' %}
											{% elseif task.priority == 'BASSE' %}
												{% set priorityClass = 'bg-success' %}
											{% endif %}
											<span class="badge {{ priorityClass }}">{{ task.priority }}</span>
										</td>
										<td>
											{% set statusClass = '' %}
											{% if task.status == 'A_FAIRE' %}
												{% set statusClass = 'bg-secondary' %}
											{% elseif task.status == 'EN_COURS' %}
												{% set statusClass = 'bg-info' %}
											{% elseif task.status == 'TERMINE' %}
												{% set statusClass = 'bg-success' %}
											{% elseif task.status == 'BLOQUE' %}
												{% set statusClass = 'bg-danger' %}
											{% endif %}
											<span class="badge {{ statusClass }}">{{ task.status }}</span>
										</td>
									</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="5" class="text-center">No recent tasks found</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>

		<!-- Leave Balances -->
		<div class="card mb-4">
			<div class="card-header">
				<i class="fas fa-clock me-2"></i>
				Solde de congés (top 5)
			</div>
			<div class="card-body">
				<div class="table-responsive">
					<table class="table table-sm">
						<thead>
							<tr>
								<th>Employé</th>
								<th>Jours restants</th>
							</tr>
						</thead>
						<tbody>
							{% if leaveBalances is defined and leaveBalances %}
								{% for balance in leaveBalances|slice(0, 5) %}
									<tr>
										<td>{{ balance.firstname }}
											{{ balance.lastname }}</td>
										<td>{{ balance.conge_restant }}</td>
									</tr>
								{% endfor %}
							{% else %}
								<tr>
									<td colspan="2" class="text-center">No leave balances found</td>
								</tr>
							{% endif %}
						</tbody>
					</table>
				</div>
			</div>
		</div>
	</div>
{% endblock %}