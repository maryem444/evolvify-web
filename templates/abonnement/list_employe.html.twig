{% extends 'base.html.twig' %}

{% block title %}Gestion des Abonnements{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <h2 class="mb-4">Gestion des Abonnements</h2>
    <p class="text-muted">Gérez et suivez tous les abonnements des employés</p>

    <!-- Ajout rapide -->
    <div class="col-md-8 d-flex align-items-center justify-content-end mb-3">
        <button class="btn btn-lg btn-primary" data-bs-toggle="modal" data-bs-target="#ajoutAbonnementModal">
            + Nouvel Abonnement
        </button>
    </div>

    <!-- Statistiques -->
    <div class="row text-white mb-4">
        <div class="col-md-3">
            <div class="card bg-success shadow">
                <div class="card-body">
                    <h5 class="card-title">Taux d'activité</h5>
                    <h3 id="tauxActivite">{{ tauxActivite }}%</h3>
                    <canvas id="tauxActiviteChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-primary shadow">
                <div class="card-body">
                    <h5 class="card-title">Types d’abonnements</h5>
                    <h3 id="typesAbonnements">{{ typesStats|length }}</h3>
                    <canvas id="typesAbonnementsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-info shadow">
                <div class="card-body">
                    <h5 class="card-title">Employés actifs</h5>
                    <h3 id="employesActifs">{{ employesActifs }}</h3>
                    <canvas id="employesActifsChart"></canvas>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card bg-light border-0 shadow">
                <div class="card-body">
                    <h5 class="card-title">Abonnements Populaires</h5>
                    <ul class="list-group">
                        {% for type, pourcentage in pourcentagesTypes %}
                            <li class="list-group-item d-flex justify-content-between">
                                <span>{{ type }}</span>
                                <span>{{ pourcentage }}%</span>
                            </li>
                        {% endfor %}
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Liste des abonnements en cards -->
<div class="card shadow mb-4">
    <div class="card-header bg-dark text-white">
        <h5 class="mb-0">Liste des Abonnements</h5>
    </div>
    <div class="card-body">
        {% if abonnements is not empty %}
            <div class="row">
                {% for abonnement in abonnements %}
                    <div class="col-md-4 mb-4">
                        <div class="card border-0 shadow-lg 
                            {% if abonnement.status.value == 'ACTIF' %}bg-success text-white
                            {% else %}bg-secondary text-white
                            {% endif %}">
                            <div class="card-body">
                                <h5 class="card-title">{{ abonnement.type_Ab }}</h5>
                                <p class="card-text mb-1">
                                    <strong>Début :</strong> {{ abonnement.date_debut|date('d/m/Y') }}
                                </p>
                                <p class="card-text mb-1">
                                    <strong>Expiration :</strong> {{ abonnement.date_exp|date('d/m/Y') }}
                                </p>
                                <p class="card-text mb-1">
                                    <strong>Prix :</strong> {{ abonnement.prix }} DT
                                </p>
                                <p class="card-text mb-2">
                                    <strong>Employé :</strong> ID {{ abonnement.id_employe }}
                                </p>
                                <span class="badge bg-light text-dark">{{ abonnement.status.value }}</span>
                            </div>
                            <div class="card-footer bg-transparent border-0 d-flex justify-content-between">
                                <button class="btn btn-sm btn-outline-light edit-button"
                                        data-bs-toggle="modal"
                                        data-bs-target="#editAbonnementModal"
                                        data-id="{{ abonnement.id_Ab }}">
                                    Modifier
                                </button>
                                <button class="btn btn-sm btn-outline-danger btn-delete"
                                       data-id="{{ abonnement.id_Ab }}">Supprimer
                                </button>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
        {% else %}
            <div class="alert alert-info">Aucun abonnement disponible.</div>
        {% endif %}
    </div>
</div>
</div>

{% include 'abonnement/edit.html.twig' %}
{% include 'abonnement/add.html.twig' %}

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function () {
    document.querySelectorAll(".btn-delete").forEach(button => {
        button.addEventListener("click", function () {
            const abonnementId = this.getAttribute("data-id");

            if (confirm("Êtes-vous sûr de vouloir supprimer cet abonnement ?")) {
                fetch(`/abonnement/delete/${abonnementId}`, {
                    method: "DELETE",
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error("La suppression a échoué.");
                    }
                    return response.json();
                })
                .then(data => {
                    alert(data.message);
                    // Supprimer la carte ou recharger la page
                    location.reload(); // ou supprimer dynamiquement la carte HTML
                })
                .catch(error => {
                    console.error("Erreur:", error);
                    alert("Erreur lors de la suppression.");
                });
            }
        });
    });
});
</script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const tauxActivite = {{ tauxActivite }};
        const typesLabels = {{ typesStats|keys|json_encode|raw }};
        const typesData = [
            {% for key in typesStats|keys %}
                {{ typesStats[key] }}{% if not loop.last %}, {% endif %}
            {% endfor %}
        ];
        const employesActifs = {{ employesActifs }};

        new Chart(document.getElementById('tauxActiviteChart'), {
            type: 'doughnut',
            data: {
                labels: ['Activité', 'Inactivité'],
                datasets: [{
                    data: [tauxActivite, 100 - tauxActivite],
                    backgroundColor: ['#28a745', '#f0f0f0'],
                }]
            }
        });

        new Chart(document.getElementById('typesAbonnementsChart'), {
            type: 'bar',
            data: {
                labels: typesLabels,
                datasets: [{
                    label: 'Nombre d’abonnements',
                    data: typesData,
                    backgroundColor: '#007bff'
                }]
            }
        });

        new Chart(document.getElementById('employesActifsChart'), {
            type: 'line',
            data: {
                labels: ['Jan', 'Fév', 'Mar'],
                datasets: [{
                    label: 'Employés actifs',
                    data: [employesActifs - 1, employesActifs, employesActifs],
                    fill: false,
                    borderColor: '#17a2b8',
                    tension: 0.1
                }]
            }
        });
    });
</script>
{% endblock %}
