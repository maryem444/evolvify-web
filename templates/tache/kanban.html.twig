{% extends 'base.html.twig' %}

{% block title %}Kanban -
	{{ projet.name }}
{% endblock %}

{% block stylesheets %}
	{{ parent() }}
	<style>
		.kanban-board {
			display: flex;
			gap: 10px;
			overflow-x: auto;
			padding: 10px;
			min-height: 600px;
		}

		.kanban-column {
			flex: 1;
			min-width: 250px;
			border-radius: 5px;
		}

		.kanban-column-header {
			padding: 10px;
			text-align: center;
			color: white;
			font-weight: bold;
			border-radius: 5px 5px 0 0;
		}

		.to-do-header {
			background-color: #2196F3;
		}
		.in-progress-header {
			background-color: #FF9800;
		}
		.done-header {
			background-color: #4CAF50;
		}
		.canceled-header {
			background-color: #9C27B0;
		}

		.kanban-column-content {
			padding: 10px;
			min-height: 500px;
		}

		.to-do-content {
			background-color: #E3F2FD;
		}
		.in-progress-content {
			background-color: #FFF3E0;
		}
		.done-content {
			background-color: #E8F5E9;
		}
		.canceled-content {
			background-color: #F3E5F5;
		}

		.task-card {
			background-color: white;
			border-radius: 5px;
			padding: 10px;
			margin-bottom: 10px;
			box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
			position: relative;
			color: black;
		}

		.task-card.priority-low {
			border-left: 4px solid #2196F3;
		}
		.task-card.priority-medium {
			border-left: 4px solid #FF9800;
		}
		.task-card.priority-high {
			border-left: 4px solid #F44336;
		}

		.task-delete-btn {
			position: absolute;
			bottom: 5px; /* Repositionner en haut */
			right: 5px;
			color: #F44336;
			background: none;
			border: none;
			cursor: pointer;
			font-size: 1.2rem;
		}

		.progress-bar {
			height: 15px;
			background-color: #E0E0E0;
			border-radius: 10px;
			margin: 10px 0;
		}

		.progress-bar-fill {
			height: 100%;
			border-radius: 10px;
			height: 20px;
		}

		.progress-bar-fill.in-progress {
			background-color: #FF9800;
		}
		.progress-bar-fill.done {
			background-color: #4CAF50;
		}

		.task-form-container {
			max-width: 600px;
			margin: 0 auto 20px;
			padding: 20px;
			background-color: #f5f5f5;
			border-radius: 5px;
		}

		.priority-low {
			color: #2196F3;
		}
		.priority-medium {
			color: #FF9800;
		}
		.priority-high {
			color: #F44336;
		}
		.task-card h5,
		.task-card p,
		.task-card span {
			color: #000000 !important;
		}
		.actions-container {
			margin-top: 20px;
			margin-bottom: 20px;
			text-align: left;
		}

		.btn-return {
			background-color: #034694;
			color: white;
			padding: 8px 16px;
			border-radius: 5px;
			text-decoration: none;
			display: inline-flex;
			align-items: center;
			gap: 8px;
			font-weight: 500;
			transition: background-color 0.3s;
		}

		.btn-return:hover {
			background-color: #023a7a;
			text-decoration: none;
			color: white;
		}

		.btn-return i {
			margin-right: 5px;
		}
		.add-task-btn {
			background-color: #28a745;
			color: white;
			padding: 10px 15px;
			border-radius: 5px;
			text-decoration: none;
			font-weight: bold;
			display: inline-block;
			margin-bottom: 15px;
		}
		.add-task-btn:hover {
			background-color: #218838;
			color: white;
		}

		/* Modal styles */
		.overlay {
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-color: rgba(0, 0, 0, 0.5);
			display: none;
			justify-content: center;
			align-items: center;
			z-index: 1050;
			padding: 20px;
			overflow: auto;
		}

		.modal-custom {
			background-color: #fff;
			border-radius: 10px;
			padding: 20px;
			width: 500px;
			max-height: 90vh;
			overflow-y: auto;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
			position: relative;
		}

		.modal-header {
			font-size: 18px;
			font-weight: bold;
			margin-bottom: 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}

		.modal-body input,
		.modal-body select {
			width: 100%;
			padding: 10px;
			margin-bottom: 15px;
			border-radius: 5px;
			border: 1px solid #ccc;
		}

		.modal-body .form-icon {
			margin-right: 10px;
		}

		.modal-footer {
			text-align: right;
			display: flex;
			justify-content: flex-end;
			gap: 10px;
			margin-top: 15px;
		}

		.close-btn {
			color: #888;
			font-size: 24px;
			cursor: pointer;
			line-height: 1;
		}

		.modal-body input:focus,
		.modal-body select:focus {
			border-color: #4CAF50;
			box-shadow: 0 0 5px rgba(0, 123, 255, 0.5);
			outline: none;
		}

		@media(max-width: 480px) {
			.modal-custom {
				width: 95%;
				margin: 0 auto;
			}
		}

		.form-error {
			color: #e74c3c;
			font-size: 13px;
			margin-top: 5px;
			display: block;
		}

		.is-invalid {
			border-color: #e74c3c !important;
		}
	</style>
{% endblock %}

{% block content %}
	<div class="container mt-4">
		<h1>Projet :
			{{ projet.name }}</h1>

		{% for label, messages in app.flashes %}
			{% for message in messages %}
				<div class="alert alert-{{ label }}">
					{{ message }}
				</div>
			{% endfor %}
		{% endfor %}

		<a href="#" class="add-task-btn" onclick="openModal()">+ Ajouter Tâche</a>

		<div class="kanban-board">
			{% for status, columnClass in {'TO_DO': 'to-do', 'IN_PROGRESS': 'in-progress', 'DONE': 'done', 'CANCELED': 'canceled'} %}
				<div class="kanban-column">
					<div class="kanban-column-header {{ columnClass }}-header">{{ status|capitalize }}</div>
					<div class="kanban-column-content {{ columnClass }}-content">
						{% if tasksByStatus is defined and tasksByStatus[status] is not empty %}
							{% for task in tasksByStatus[status] %}
								<div class="task-card priority-{{ task.priority.value|lower }}">
									{% if status == 'IN_PROGRESS' %}
										<div class="progress-bar">
											<div class="progress-bar-fill in-progress" style="width: 50%;">
												<span>50%</span>
											</div>
										</div>
									{% endif %}
									{% if status == 'DONE' %}
										<div class="progress-bar">
											<div class="progress-bar-fill done" style="width: 100%;">
												<span>100%</span>
											</div>
										</div>
									{% endif %}

									<h5>Description :
										{{ task.description }}</h5>
									<p>Date :
										{{ task.createdAt|date('Y-m-d') }}</p>
									<p>Employé ID :
										{{ task.idEmploye }}</p>
									<p class="priority-{{ task.priority.getLabel()}}">Priorité :
										{{ task.priority.getLabel() }}</p>

									<form action="{{ path('kanban_task_delete', {'id': projet.id, 'tacheId': task.getIdTache}) }}" method="post" onsubmit="return confirm('Êtes-vous sûr de vouloir supprimer cette tâche?');">
										<button type="submit" class="task-delete-btn" aria-label="Supprimer la tâche">
											<i class="fas fa-trash-alt"></i>
										</button>
									</form>
								</div>
							{% endfor %}
						{% else %}
							<p>Aucune tâche dans cette catégorie.</p>
						{% endif %}
					</div>
				</div>
			{% endfor %}
		</div>

		<div class="actions-container mt-3">
			<a href="{{ path('projets_cards') }}" class="btn-return">
				<i class="fas fa-arrow-left"></i>
				Retour à la liste
			</a>
		</div>

		<!-- Modal pour ajouter une tâche -->
		<div class="overlay" id="overlay">
			<div class="modal-custom">
				<div class="modal-header">
					<h5>Ajouter une Tâche</h5>
					<span class="close-btn" onclick="closeModal()">&times;</span>
				</div>
				<div class="modal-body">
					{{ form_start(form, {'action': path('kanban_task_add', {'id': projet.id}), 'method': 'POST'}) }}
					{{ form_errors(form) }}

					<div class="form-group">
						{{ form_label(form.description) }}
						{{ form_widget(form.description, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(form.description) }}
					</div>

					<div class="form-group">
						{{ form_label(form.status) }}
						{{ form_widget(form.status, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(form.status) }}
					</div>

					<div class="form-group">
						{{ form_label(form.priority) }}
						{{ form_widget(form.priority, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(form.priority) }}
					</div>

					<div class="form-group">
						{{ form_label(form.location) }}
						{{ form_widget(form.location, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(form.location) }}
					</div>

					<div class="form-group">
						{{ form_label(form.createdAt) }}
						{{ form_widget(form.createdAt, {'attr': {'class': 'form-control'}}) }}
						{{ form_errors(form.createdAt) }}
					</div>

					{{ form_widget(form.idEmploye) }}

					<div class="modal-footer">
						<button type="button" class="btn btn-secondary" onclick="closeModal()">Annuler</button>
						{{ form_widget(form.submit, {'attr': {'class': 'btn btn-primary'}}) }}
					</div>
					{{ form_end(form) }}
				</div>
			</div>
		</div>
	</div>

	<script>
		function openModal(tacheId = null, description = '', location = '') {
let form = document.querySelector("#overlay form");

if (tacheId) { // Mode édition
form.action = `/projets/{{ projet.id }}/taches/edit/` + tacheId;
document.querySelector("#overlay h5").innerText = "Modifier une Tâche";
document.querySelector("#tache_description").value = description;
document.querySelector("#tache_location").value = location;
} else { // Mode ajout
form.action = `/projets/{{ projet.id }}/taches/ajouter`;
document.querySelector("#overlay h5").innerText = "Ajouter une Tâche";
document.querySelector("#tache_description").value = '';
document.querySelector("#tache_location").value = '';
}

document.getElementById("overlay").style.display = "flex";
}

function closeModal() {
document.getElementById("overlay").style.display = "none";
}
	</script>
{% endblock %}
